# AI Sheet: PHP Compatibility (Target 7.3)

Generated by `ai_sheet_setup.py`.

## Target

- **PHP version:** 7.3
- **Goal:** All pages should run without fatal errors on PHP 7.3.

## Allowed language features (safe on 7.3)

- Scalar + nullable type hints: `function f(?string $x): ?int`
- Null coalescing: `$x = $_GET['x'] ?? ''`
- Short array syntax: `[]`
- `Throwable` / `Exception`

## Avoid (common breakages when targeting 7.3)

- Typed properties (`public int $x;`) (PHP 7.4+)
- Arrow functions (`fn($x) => ...`) (PHP 7.4+)
- Nullsafe operator (`$a?->b`) (PHP 8.0+)
- `match` expressions (PHP 8.0+)
- Union types (`int|string`) (PHP 8.0+)
- Named arguments (PHP 8.0+)
- Constructor property promotion (PHP 8.0+)
- `str_starts_with`, `str_ends_with`, `str_contains` (PHP 8.0+)

## Reliability rules

- Never hard-`exit` on missing directories (except deliberate access-control blocks).
- Prefer collecting errors and rendering them in the UI so a fresh install can self-diagnose.
- When creating directories, handle failure and include a fix command.

## Filesystem expectations

Common writable dirs for SQLite + uploads:

- `/web/private/db/memory/`
- `/web/private/uploads/memory/`

Recommended fix commands:

```bash
sudo mkdir -p /web/private/db/memory /web/private/uploads/memory
sudo chown -R www-data:www-data /web/private/db/memory /web/private/uploads/memory
sudo chmod 775 /web/private/db/memory /web/private/uploads/memory
```

## Bash History Ingest (Hourly) DB Schema

The hourly ingest script is:

- `/web/html/v1/notes/scripts/ingest_bash_history_to_kb.py`

It writes to:

- **KB DB:** `/web/private/db/memory/bash_history.db`
- **State DB:** `/web/private/db/memory/human_notes.db` (table: `history_state`)

### `bash_history.db`

```sql
CREATE TABLE IF NOT EXISTS commands (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    full_cmd TEXT NOT NULL UNIQUE,
    base_cmd TEXT NOT NULL,
    first_seen TEXT DEFAULT (datetime('now')),
    last_seen  TEXT DEFAULT (datetime('now')),
    seen_count INTEGER DEFAULT 1
);
CREATE INDEX IF NOT EXISTS idx_commands_base_cmd ON commands(base_cmd);

CREATE TABLE IF NOT EXISTS command_ai (
    cmd_id INTEGER PRIMARY KEY,
    status TEXT DEFAULT 'pending',
    model TEXT,
    prompt_version TEXT,
    result_json TEXT,
    summary TEXT,
    search_query TEXT,
    known INTEGER DEFAULT 0,
    updated_at TEXT DEFAULT (datetime('now')),
    last_error TEXT
);
CREATE INDEX IF NOT EXISTS idx_command_ai_status ON command_ai(status, updated_at);

CREATE TABLE IF NOT EXISTS base_commands (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    base_cmd TEXT NOT NULL UNIQUE,
    first_seen TEXT DEFAULT (datetime('now')),
    last_seen  TEXT DEFAULT (datetime('now')),
    seen_count INTEGER DEFAULT 1
);

CREATE TABLE IF NOT EXISTS enrich_queue (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    kind TEXT NOT NULL,
    ref TEXT NOT NULL,
    status TEXT DEFAULT 'pending',
    priority INTEGER DEFAULT 100,
    attempts INTEGER DEFAULT 0,
    last_error TEXT,
    created_at TEXT DEFAULT (datetime('now')),
    updated_at TEXT DEFAULT (datetime('now')),
    UNIQUE(kind, ref)
);
CREATE INDEX IF NOT EXISTS idx_queue_status_priority ON enrich_queue(status, priority, created_at);
```

### `human_notes.db` state table

```sql
CREATE TABLE IF NOT EXISTS history_state (
    host TEXT NOT NULL,
    path TEXT NOT NULL,
    inode TEXT,
    last_line INTEGER DEFAULT 0,
    updated_at TEXT,
    PRIMARY KEY (host, path)
);
```

## Quick checks

- Syntax check: `php -l path/to/file.php`
- Scan for incompatibilities (heuristic): `./ai_sheet_setup.py --target 7.3 --scan --root /web/html`
