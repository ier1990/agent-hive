Options -Indexes -MultiViews +FollowSymlinks
RewriteEngine On
RewriteBase /v1/

# Block dotfiles (e.g. .env) from being served under /v1
RewriteRule (^|/)\.[^/]+ - [F,L]

# Do not force slash removal globally.
# Many /v1 endpoints are directory-backed; Apache DirectorySlash may canonicalize to trailing slash.
# Route rules below accept both forms where needed.

# Block direct .php (browser/client requests). Includes still work.
RewriteCond %{THE_REQUEST} \s/+v1/.*\.php[\s?] [NC]
RewriteRule ^ - [R=404,L]

# Core endpoints (explicit, current directory layout)
RewriteRule ^ping/?$      ping/index.php      [QSA,NC,L]
RewriteRule ^health/?$    health/index.php    [QSA,NC,L]
RewriteRule ^models/?$    models/index.php    [QSA,NC,L]
RewriteRule ^inbox/?$     inbox/index.php     [QSA,NC,L]

# OpenAI-compatible chat completions shim
RewriteRule ^chat/completions$ chat/completions/index.php [QSA,NC,L]

# Existing routes (current layout)
RewriteRule ^receiving/?$           receiving/receiving.php [QSA,NC,L]
RewriteRule ^answer/?$              answer/index.php        [QSA,NC,L]
RewriteRule ^search/?$              search/index.php        [QSA,NC,L]

# Server coordination
RewriteRule ^servers(?:/(.*))?$     servers/index.php?after=$1 [QSA,NC,L]

# Releases (directory router)
RewriteRule ^releases(?:/(.*))?$    releases/index.php?after=$1 [QSA,NC,L]

# Story routes
RewriteRule ^story/?$               story.php                [QSA,NC,L]
RewriteRule ^story/create/?$        story/create.php         [QSA,NC,L]
RewriteRule ^story/turn/?$          story/turn.php           [QSA,NC,L]
RewriteRule ^story/list/?$          story/list.php           [QSA,NC,L]
RewriteRule ^story/relay/?$         story/relay.php          [QSA,NC,L]

# Front controller (only for unknown routes)
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^ index.php [QSA,NC,L]
